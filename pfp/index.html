<!doctype html>
<html lang="en">

<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>$PEENG</title>
<link rel="shortcut icon" href="images/r3.png" type="image/png">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    /* Disable text selection */
    body {
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
    }

    /* Prevent dragging for images and videos only */
    img, video {
      -webkit-user-drag: none;
    }
    
    .franchise-info {
      text-align: center;
      padding: 12px;
      background: rgba(255, 176, 32, 0.05);
      margin-bottom: 12px;
      border-radius: 8px;
      transition: all 0.3s ease;
      border: 1px solid rgba(255, 176, 32, 0.1);
    }
    
    .franchise-info:hover {
      background: rgba(255, 176, 32, 0.1);
      border-color: rgba(255, 176, 32, 0.2);
    }
    
    .wallet-address {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      margin: 8px 0;
      cursor: pointer;
      padding: 6px 12px;
      border-radius: 6px;
      background: rgba(255, 255, 255, 0.03);
      transition: all 0.2s ease;
    }
    
    .wallet-address:hover {
      background: rgba(255, 176, 32, 0.1);
    }
    
    .wallet-address:active {
      transform: scale(0.98);
    }
    
    .social-links {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 8px;
    }
    
    .social-link {
      color: #9aa5b2;
      font-size: 18px;
      transition: all 0.2s ease;
    }
    
    .social-link:hover {
      color: #ffb020;
      transform: translateY(-2px);
    }
    
    .copy-notification {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #ffb020;
      color: #071025;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
      opacity: 0;
      transition: opacity 0.3s ease;
      z-index: 1000;
    }
    
    :root{--bg:#071025;--card:#0d1724;--muted:#9aa5b2;--accent:#ffb020}
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#05273b 0,#071025 100%);font-family:Inter,system-ui,Segoe UI,Roboto,Arial;color:#e6eef6}

    .wrap {
      display: grid;
      grid-template-columns: 320px 1fr 320px;
      grid-template-rows: auto 1fr auto;
      height: 100vh;
      max-height: 100vh;
      overflow: hidden;
      padding: 14px;
      gap: 14px;
    }
    
    .center {
      display: flex;
      justify-content: center;
      align-items: center;
      height: calc(100vh - 140px);
    }

    .left-panel, .right-panel {
      overflow-y: auto;
      height: 100%;
    }
    
    .center-panel {
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden;
    }
    
    canvas {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }
    
    header{grid-column:1/-1;display:flex;align-items:center;gap:12px;padding:8px 4px}
    h1{margin:0;color:var(--accent);font-size:18px}
    .panel{background:var(--card);border-radius:10px;padding:12px;border:1px solid rgba(255,255,255,0.03)}
    .left{height:calc(100vh - 140px);overflow:auto}
    .right{height:calc(100vh - 140px);overflow:auto;display:flex;flex-direction:column;gap:12px}
    .stickers{display:flex;flex-wrap:wrap;gap:8px}
    .sticker-btn{width:64px;height:64px;border-radius:10px;background:rgba(255,255,255,0.02);display:flex;align-items:center;justify-content:center;cursor:pointer;border:1px solid rgba(255,255,255,0.03)}
    .sticker-btn img{max-width:46px;max-height:46px;pointer-events:none}
    .controls-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .canvas-wrap{display:flex;flex-direction:column;align-items:stretch;gap:8px}
    canvas#stage{background:linear-gradient(180deg,#0b1220,#071025);border-radius:10px;border:6px solid rgba(255,176,32,0.05);width:100%;height:auto;display:block}
    .label{font-size:13px;color:var(--muted);margin-bottom:6px}
    .small{font-size:13px;color:#bfcfe0}
    .btn{background:var(--accent);color:#061018;padding:8px 10px;border-radius:8px;border:none;cursor:pointer;font-weight:600}
    .ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);padding:8px 10px;border-radius:8px;cursor:pointer}
    .prop-row{display:flex;gap:8px;align-items:center;margin-top:6px}
    .input{width:100%;padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
    .overlay-list{display:flex;flex-direction:column;gap:6px;max-height:180px;overflow:auto;margin-top:8px}
    .overlay-item{display:flex;align-items:center;gap:8px;padding:6px;border-radius:8px;background:rgba(255,255,255,0.01)}
    .overlay-item img{width:36px;height:36px;object-fit:contain}
    .small-btn{padding:6px;border-radius:6px;border:none;background:rgba(255,255,255,0.03);color:var(--muted);cursor:pointer}
    footer{grid-column:1/-1;color:var(--muted);font-size:13px;padding-top:6px}
    
    @media(max-width:980px){.wrap{grid-template-columns:1fr;padding:8px} .left{height:auto} .right{height:auto} canvas#stage{max-height:420px}}

    /* Mobile Layout */
    @media (max-width: 1200px) {
      .wrap {
        grid-template-columns: 1fr;
        grid-template-rows: auto auto auto auto;
        height: auto;
        min-height: 100vh;
        overflow: visible;
      }
      
      .left-panel, .center-panel, .right-panel {
        overflow: visible;
        height: auto;
      }
      
      .center-panel {
        height: 60vh;
        min-height: 400px;
      }
      
      body {
        overflow-y: auto;
      }
    }
</style>
</head>

<body>
<div class="wrap">
  <header>
    <div style="width:36px;height:36px;border-radius:8px;background: url('peegpfp.png') center/cover no-repeat;"></div>
    <h1>PeegPFPr</h1>
    <div style="margin-left:auto" class="small">PEENG CUSTOMIZABLE: <strong>Just as you Want It</strong></div>
  </header>

  <!-- LEFT COLUMN - Main Controls -->
  <aside class="panel left-panel">
    <div class="franchise-info">
      <div style="font-size: 14px; color: #ffb020; font-weight: 500;">PEENG INFO</div>
      <div class="wallet-address" id="walletAddress" title="Click to copy">
        <span>0xC52B4Da...6237A7B2</span>
        <i class="far fa-copy" style="font-size: 12px;"></i>
      </div>
      <div class="social-links">
        <a href="https://x.com/peengonabstract" target="_blank" class="social-link">
          <i class="fab fa-twitter"></i>
        </a>
        <a href="https://t.me/+qH68Lgd9Sk5mNmJl" target="_blank" class="social-link">
          <i class="fab fa-telegram"></i>
        </a>
        <a href="#https://discord.gg/yourinvite" target="_blank" class="social-link">
          <i class="fab fa-discord"></i>
        </a>
      </div>
    </div>

    <div class="copy-notification" id="copyNotification">Copied!</div>

    <div>
      <div class="label">Accessories / Stickers</div>
      <div class="stickers" id="stickersRow"></div>
    </div>

    <hr style="border:none;height:10px">
    
    <div style="margin-top: 12px">
      <div class="label">Base Image Filters</div>
      <div class="small">Brightness <span id="brightVal">100%</span></div>
      <input id="brightness" type="range" min="40" max="180" value="100" style="width:100%" />
      <div class="small">Contrast <span id="contrastVal">100%</span></div>
      <input id="contrast" type="range" min="40" max="180" value="100" style="width:100%" />
      <div class="small">Grayscale <span id="grayVal">0%</span></div>
      <input id="grayscale" type="range" min="0" max="100" value="0" style="width:100%" />
      <div class="small">Hue rotate <span id="hueVal">0°</span></div>
      <input id="hue" type="range" min="0" max="360" value="0" style="width:100%" />
      <div class="small" style="margin-top:6px">Filters apply to the base image and are included in export.</div>
    </div>
  </aside>

  <!-- CENTER COLUMN - Canvas -->
  <main class="panel center-panel">
    <div class="canvas-wrap">
      <canvas id="stage" width="512" height="512"></canvas>
    </div>
  </main>

  <!-- RIGHT COLUMN - Overlay Tools & Export -->
  <aside class="panel right-panel">
    <div style="margin-top:8px">
      <div class="label">Overlays</div>
      <div class="overlay-list" id="overlayList"></div>
    </div>

    <div style="margin-top:12px">
      <div class="controls-row">
        <button id="randomizeBtn" class="ghost small-btn">Randomize</button>
        <button id="resetBtn" class="ghost small-btn">Reset</button>
      </div>
      
 <!-- Tip Text -->
      <div class="small" style="margin-top: 12px; color: var(--muted)">
        Tip: Click on overlays to select and adjust them.
      </div>
      
      <div style="display:flex;gap:6px;align-items:center;margin-top:8px">
        <div class="small">Selected overlay</div>
        <button id="flipBtn" class="small-btn" title="Flip">⇋</button>
        <button id="delBtn" class="small-btn" title="Delete">✕</button>
      </div>

     
    </div>

    <div style="margin-top:12px">
      <div class="label">Background Color</div>
      <div class="controls-row">
        <input id="bgColor" type="color" value="#071025" style="width:60px;height:36px;border-radius:6px;border:none;padding:0">
        <button id="transparentBgBtn" class="ghost">Transparent</button>
        <button id="defaultBgBtn" class="ghost">Default</button>
      </div>
      <div class="small" style="margin-top:6px">Leave transparent for PNG with alpha channel</div>
    </div>

    <div class="panel" style="margin-top:12px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div class="small">Export & metadata</div><br>
        <div style="display:flex;gap:8px;align-items:center">
          <select id="exportSize">
            <option value="512">Export 512×512</option>
            <option value="1024" selected>Export 1024×1024</option>
            <option value="2048">Export 2048×2048</option>
          </select>
          <button id="exportBtn" class="btn">Export PNG</button>
        </div>
      </div>
      <div class="small" style="margin-top:8px;color:var(--muted)">Export composes the base image (with filters), background, overlays, and text at chosen resolution.</div>
    </div>

    <div class="panel" style="margin-top:12px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div class="small">Export & metadata</div>
        <div style="display:flex;gap:8px">
          <button id="downloadMeta" class="ghost">Download JSON</button>
        </div>
      </div>
    </div>
  </aside>

  <footer>Built for<code> PEENG-PFP</code></footer>
</div>

<script>
/* CONFIG */
const BASE_IMAGE_SRC = 'https://scrweb.vercel.app/pfp/peegpfp.png'; // make sure file is in repo root

/* STICKERS - Updated to match your 20 sticker files */
const STICKERS = [
  { id: 'sticker1', name: 'Sticker 1', src: 'https://scrweb.vercel.app/pfp/assets/sticker1.PNG' },
  { id: 'sticker2', name: 'Sticker 2', src: 'https://scrweb.vercel.app/pfp/assets/sticker2.PNG' },
  { id: 'sticker3', name: 'Sticker 3', src: 'https://scrweb.vercel.app/pfp/assets/sticker3.PNG' },
  { id: 'sticker4', name: 'Sticker 4', src: 'https://scrweb.vercel.app/pfp/assets/sticker4.PNG' },
  { id: 'sticker5', name: 'Sticker 5', src: 'https://scrweb.vercel.app/pfp/assets/sticker5.PNG' },
  { id: 'sticker6', name: 'Sticker 6', src: 'https://scrweb.vercel.app/pfp/assets/sticker6.PNG' },
  { id: 'sticker7', name: 'Sticker 7', src: 'https://scrweb.vercel.app/pfp/assets/sticker7.PNG' },
  { id: 'sticker8', name: 'Sticker 8', src: 'https://scrweb.vercel.app/pfp/assets/sticker8.PNG' },
  { id: 'sticker9', name: 'Sticker 9', src: 'https://scrweb.vercel.app/pfp/assets/sticker9.PNG' },
  { id: 'sticker10', name: 'Sticker 10', src: 'https://scrweb.vercel.app/pfp/assets/sticker10.PNG' },
  { id: 'sticker11', name: 'Sticker 11', src: 'https://scrweb.vercel.app/pfp/assets/sticker11.PNG' },
  { id: 'sticker12', name: 'Sticker 12', src: 'https://scrweb.vercel.app/pfp/assets/sticker12.PNG' },
  { id: 'sticker13', name: 'Sticker 13', src: 'https://scrweb.vercel.app/pfp/assets/sticker13.PNG' },
  { id: 'sticker14', name: 'Sticker 14', src: 'https://scrweb.vercel.app/pfp/assets/sticker14.PNG' },
  { id: 'sticker15', name: 'Sticker 15', src: 'https://scrweb.vercel.app/pfp/assets/sticker15.PNG' },
  { id: 'sticker16', name: 'Sticker 16', src: 'https://scrweb.vercel.app/pfp/assets/sticker16.PNG' },
  { id: 'sticker17', name: 'Sticker 17', src: 'https://scrweb.vercel.app/pfp/assets/sticker17.PNG' },
  { id: 'sticker18', name: 'Sticker 18', src: 'https://scrweb.vercel.app/pfp/assets/sticker18.PNG' },
  { id: 'sticker19', name: 'Sticker 19', src: 'https://scrweb.vercel.app/pfp/assets/sticker19.PNG' },
  { id: 'sticker20', name: 'Sticker 20', src: 'https://scrweb.vercel.app/pfp/assets/sticker20.PNG' }
];

/* REFERENCES */
const canvas = document.getElementById('stage');
const ctx = canvas.getContext('2d', { alpha: true });
const stickersRow = document.getElementById('stickersRow');
const overlayListEl = document.getElementById('overlayList');
const exportSizeSelect = document.getElementById('exportSize');

/* STATE */
let canvasWidth = canvas.width, canvasHeight = canvas.height;
let filters = { brightness:100, contrast:100, grayscale:0, hue:0 };
let overlays = []; // { id, type:'sticker'|'text', img, name, text, x,y,scale,rot,flip,z }
let nextId = 1;
let selectedId = null;
let needDraw = true;
let bgColor = null; // null = transparent, string = color

/* BASE IMAGE LOAD (important: set crossOrigin THEN src for some hosts) */
const baseImage = new Image();
baseImage.crossOrigin = 'anonymous';
baseImage.src = BASE_IMAGE_SRC;
baseImage.onload = () => { requestDraw(); };

/* INIT UI */
STICKERS.forEach(s=>{
  const btn = document.createElement('div'); btn.className='sticker-btn'; btn.title=s.name;
  const img = new Image(); img.src = s.src; img.alt = s.name;
  btn.appendChild(img);
  btn.addEventListener('click', ()=> {
    // Remove any existing sticker overlay before adding new one
    overlays = overlays.filter(o => o.type !== 'sticker');
    addSticker(s);
  });
  stickersRow.appendChild(btn);
});

/* Filters */
['brightness','contrast','grayscale','hue'].forEach(k=>{
  document.getElementById(k).addEventListener('input',(e)=>{ filters[k]=Number(e.target.value); updateFilterLabels(); requestDraw(); });
});
function updateFilterLabels(){ document.getElementById('brightVal').textContent = filters.brightness+'%'; document.getElementById('contrastVal').textContent = filters.contrast+'%'; document.getElementById('grayVal').textContent = filters.grayscale+'%'; document.getElementById('hueVal').textContent = filters.hue+'°'; }
updateFilterLabels();

/* Background controls */
document.getElementById('bgColor').addEventListener('input', (e) => {
  bgColor = e.target.value;
  requestDraw();
});

document.getElementById('transparentBgBtn').addEventListener('click', () => {
  bgColor = null;
  document.getElementById('bgColor').value = '#071025'; // Reset color picker
  requestDraw();
});

document.getElementById('defaultBgBtn').addEventListener('click', () => {
  bgColor = '#071025';
  document.getElementById('bgColor').value = bgColor;
  requestDraw();
});

/* Controls */
document.getElementById('flipBtn').addEventListener('click', ()=> flipSelected());
document.getElementById('delBtn').addEventListener('click', ()=> deleteSelected());
document.getElementById('randomizeBtn').addEventListener('click', randomize);
document.getElementById('resetBtn').addEventListener('click', resetAll);
document.getElementById('exportBtn').addEventListener('click', exportPNG);
document.getElementById('downloadMeta').addEventListener('click', downloadMeta);

/* Keyboard delete */
window.addEventListener('keydown', (e)=> { if((e.key==='Delete' || e.key==='Backspace') && getSelected()) deleteSelected(); });

/* Add sticker */
function addSticker(s) {
  const img = new Image();
  img.onload = () => {
    // Calculate scale to fit the base image perfectly
    const baseScale = Math.min(canvasWidth / img.width, canvasHeight / img.height);
    
    const o = { 
      id: nextId++, 
      type: 'sticker', 
      img, 
      name: s.name, 
      x: canvasWidth/2, 
      y: canvasHeight/2, 
      scale: baseScale, // Set scale to fit base image
      rot: 0, 
      flip: false, 
      z: overlays.length ? Math.max(...overlays.map(x => x.z)) + 1 : 1 
    };
    overlays.push(o);
    selectedId = o.id;
    updateOverlayList();
    requestDraw();
  };
  img.onerror = () => console.error("Error loading sticker:", s.src);
  img.crossOrigin = 'anonymous';
  img.src = s.src;
}

/* Overlay list UI */
function updateOverlayList(){
  overlayListEl.innerHTML=''; const arr = overlays.slice().sort((a,b)=>b.z-a.z);
  arr.forEach(o=>{
    const el = document.createElement('div'); el.className='overlay-item';
    el.innerHTML = (o.img?`<img src="${o.img.src}">`:`<div style="width:36px;height:36px;background:rgba(255,255,255,0.02)"></div>`) +
    `<div style="flex:1"><div style="font-size:13px">${o.name}</div><div style="font-size:12px;color:var(--muted)">id:${o.id} z:${o.z}</div></div>` +
    `<div style="display:flex;flex-direction:column;gap:6px"><button class="small-btn sel">Select</button><button class="small-btn del">Del</button></div>`;
    overlayListEl.appendChild(el);
    el.querySelector('.sel').addEventListener('click', ()=> { selectedId=o.id; requestDraw(); });
    el.querySelector('.del').addEventListener('click', ()=> { overlays = overlays.filter(x=>x.id!==o.id); if(selectedId===o.id) selectedId=null; updateOverlayList(); requestDraw(); });
  });
}

/* Selection helpers */
function getSelected(){ return overlays.find(o=>o.id===selectedId); }
function flipSelected(){ const o=getSelected(); if(!o) return; o.flip = !o.flip; requestDraw(); updateOverlayList(); }
function deleteSelected(){ const o=getSelected(); if(!o) return; overlays = overlays.filter(x=>x.id!==o.id); selectedId=null; updateOverlayList(); requestDraw(); }

/* DRAW */
function requestDraw(){ needDraw=true; }
function draw(){
  if(!needDraw) return;
  needDraw=false;
  // Clear canvas with background color (or transparent)
  if (bgColor) {
    ctx.fillStyle = bgColor;
    ctx.fillRect(0, 0, canvasWidth, canvasHeight);
  } else {
    ctx.clearRect(0, 0, canvasWidth, canvasHeight);
  }

  // Draw base image with filters (center-crop)
  if(baseImage.complete && baseImage.naturalWidth){
    ctx.save();
    ctx.filter = `brightness(${filters.brightness}%) contrast(${filters.contrast}%) grayscale(${filters.grayscale}%)`;
    const ar = baseImage.width/baseImage.height;
    const canvasAr = canvasWidth/canvasHeight;
    let sx=0, sy=0, sw=baseImage.width, sh=baseImage.height;
    if(ar > canvasAr){ 
      const newW = baseImage.height * canvasAr; 
      sx=(baseImage.width-newW)/2; sw=newW; 
    } else { 
      const newH = baseImage.width / canvasAr; 
      sy=(baseImage.height-newH)/2; sh=newH; 
    }
    
    ctx.drawImage(baseImage, sx, sy, sw, sh, 0, 0, canvasWidth, canvasHeight);
    ctx.filter='none';
    ctx.restore();
  } 
  else {
    ctx.fillStyle='#0b1220'; ctx.fillRect(0,0,canvasWidth,canvasHeight);
  }

  // draw overlays by ascending z
  const arr = overlays.slice().sort((a,b)=>a.z-b.z);
  for(const o of arr) drawOverlay(o);
}
function drawOverlay(o){
  if(!o.img) return;
  ctx.save();
  ctx.translate(o.x, o.y);
  ctx.rotate(o.rot * Math.PI/180);
  ctx.scale(o.flip ? -1 : 1, 1);
  const dw = o.img.width * o.scale, dh = o.img.height * o.scale;
  ctx.drawImage(o.img, -dw/2, -dh/2, dw, dh);
  ctx.restore();
}

/* animation loop */
(function loop(){ requestAnimationFrame(loop); draw(); })();

/* RANDOMIZE / RESET */
function randomize(){ 
  overlays = []; // Clear existing overlays
  // Select one random sticker
  const s = STICKERS[Math.floor(Math.random() * STICKERS.length)];
  const img = new Image(); 
  img.src = s.src;
  img.onload = () => {
    const baseScale = Math.min(canvasWidth / img.width, canvasHeight / img.height);
    overlays.push({ 
      id: nextId++, 
      type: 'sticker', 
      img, 
      name: s.name, 
      x: canvasWidth/2, 
      y: canvasHeight/2, 
      scale: baseScale, 
      rot: 0, 
      flip: false, 
      z: 1 
    });
    selectedId = null;
    updateOverlayList();
    requestDraw();
  };
}

function resetAll(){ 
  overlays=[]; 
  selectedId=null; 
  filters={brightness:100,contrast:100,grayscale:0,hue:0}; 
  bgColor = null; // Reset background to transparent
  document.getElementById('brightness').value=100; 
  document.getElementById('contrast').value=100; 
  document.getElementById('grayscale').value=0; 
  document.getElementById('hue').value=0;
  document.getElementById('bgColor').value='#071025'; // Reset color picker
  updateFilterLabels(); 
  updateOverlayList(); 
  requestDraw(); 
}

/* EXPORT: compose on offscreen canvas with base + filters + overlays then download */
function exportPNG(){
  const size = Number(exportSizeSelect.value) || 1024;
  const out = document.createElement('canvas'); out.width = size; out.height = size;
  const oc = out.getContext('2d');

  // background: transparent (keeps PNG transparency). If you want a color fill, change here.
  if (bgColor) {
    oc.fillStyle = bgColor;
    oc.fillRect(0, 0, size, size);
  } else {
    oc.clearRect(0, 0, size, size); // Transparent background
  }

  // Draw base with same center-crop as preview
  if(baseImage.complete && baseImage.naturalWidth){
    oc.save();
    oc.filter = `brightness(${filters.brightness}%) contrast(${filters.contrast}%) grayscale(${filters.grayscale}%)`;
    const ar = baseImage.width/baseImage.height;
    const canvasAr = 1; // square target
    
    let sx=0, sy=0, sw=baseImage.width, sh=baseImage.height;
    if(ar > canvasAr){ 
      const newW = baseImage.height * canvasAr; 
      sx=(baseImage.width-newW)/2; sw=newW; 
    } else { 
      const newH = baseImage.width / canvasAr; 
      sy=(baseImage.height-newH)/2; sh=newH; 
    }
    
    oc.drawImage(baseImage, sx, sy, sw, sh, 0, 0, size, size);
    oc.filter='none';
    oc.restore();
  }

  // draw overlays scaled to output resolution
  const scaleFactor = size / canvasWidth;
  const arr = overlays.slice().sort((a,b)=>a.z-b.z);
  for(const o of arr){
    if(!o.img) continue;
    oc.save();
    oc.translate(o.x * scaleFactor, o.y * scaleFactor);
    oc.rotate(o.rot * Math.PI/180);
    oc.scale(o.flip ? -1 : 1, 1);
    const dw = o.img.width * o.scale * scaleFactor, dh = o.img.height * o.scale * scaleFactor;
    oc.drawImage(o.img, -dw/2, -dh/2, dw, dh);
    oc.restore();
  }

  // download
  out.toBlob(blob => {
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = `peegpfp-${Date.now()}.png`; a.click();
    URL.revokeObjectURL(url);
  }, 'image/png');
}

/* METADATA */
function downloadMeta(){
  const meta = { base: BASE_IMAGE_SRC, filters, overlays: overlays.map(o=>({ id:o.id, type:o.type, name:o.name, x:o.x/canvasWidth, y:o.y/canvasHeight, scale:o.scale, rot:o.rot, flip:o.flip, z:o.z, text: o.text||null })) };
  const blob = new Blob([JSON.stringify(meta,null,2)],{type:'application/json'});
  const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='peegpfp-meta.json'; a.click(); URL.revokeObjectURL(url);
}

/* UTIL */
function svgDataURI(svg){ return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg); }
function svgData(svg){ return svgDataURI(svg); }

/* Copy wallet address functionality */
const walletAddress = document.getElementById('walletAddress');
const copyNotification = document.getElementById('copyNotification');

walletAddress.addEventListener('click', () => {
  const address = '0xC52B4Da152ea081afFE8D753Ee8b691a6237A7B2'; // Full address to copy
  navigator.clipboard.writeText(address).then(() => {
    // Show notification
    copyNotification.style.opacity = '1';
    setTimeout(() => {
      copyNotification.style.opacity = '0';
    }, 2000);
  });
});

/* Security restrictions */
document.addEventListener('contextmenu', function(event) {
  event.preventDefault();
  alert("NOT ALLOWED BY MR. DEV LORD!");
});

document.addEventListener('copy', function(event) {
  event.preventDefault();
  alert("NOT ALLOWED BY MR. DEV LORD!");
});
document.addEventListener('cut', function(event) {
  event.preventDefault();
  alert("NOT ALLOWED BY MR. DEV LORD!");
});
document.addEventListener('paste', function(event) {
  event.preventDefault();
  alert("NOT ALLOWED BY MR. DEV LORD!");
});

document.addEventListener('keydown', function(event) {
  if (event.key === "PrintScreen") {
    event.preventDefault();
    alert("NOT ALLOWED BY MR. DEV LORD!");
  }
  if (event.ctrlKey && (event.key === "c" || event.key === "u" || event.key === "s" || event.key === "p")) {
    event.preventDefault();
    alert("NOT ALLOWED BY MR. DEV LORD!");
  }
  if (event.ctrlKey && event.shiftKey && (event.key === "I" || event.key === "J" || event.key === "C")) {
    event.preventDefault();
    alert("NOT ALLOWED BY MR. DEV LORD!");
  }
  if (event.key === "F12") {
    event.preventDefault();
    alert("NOT ALLOWED BY MR. DEV LORD!");
  }
});

document.addEventListener("dragstart", function(event) {
  event.preventDefault();
});
</script>
</body>
</html>
